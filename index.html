<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AnimatorShow
</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #007acc; --text: #eee; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* Dashboard */
        #dashboard { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: radial-gradient(circle, #1e1e1e 0%, #0a0a0a 100%); }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 80%; margin-top: 30px; max-height: 50vh; overflow-y: auto; padding: 10px; }
        .project-card { background: var(--panel); border: 1px solid #333; padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.3s; }
        .project-card:hover { border-color: var(--accent); transform: translateY(-5px); background: #252525; }

        /* Editor Layout */
        #editor { display: none; flex-direction: column; height: 100vh; }
        header { background: var(--panel); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; }
        
        main { display: flex; flex: 1; overflow: hidden; }
        #toolbar { width: 110px; background: var(--panel); display: flex; flex-direction: column; align-items: center; padding: 10px; gap: 8px; border-right: 1px solid #333; overflow-y: auto; }
        
        #viewport { flex: 1; position: relative; background: #252525; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #canvas-wrapper { position: relative; width: 800px; height: 450px; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        
        /* Botones */
        .btn-tool { width: 45px; height: 45px; font-size: 18px; cursor: pointer; background: #333; border: 1px solid #444; color: white; border-radius: 6px; }
        .btn-tool.active { background: var(--accent); border-color: #fff; box-shadow: 0 0 10px var(--accent); }
        .btn-video { background: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        #timeline { height: 120px; background: var(--panel); border-top: 1px solid #000; overflow-x: auto; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .frame-thumb { min-width: 100px; height: 56px; background: #fff; border: 2px solid #444; cursor: pointer; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 4px; }
        .frame-thumb.active { border-color: var(--accent); border-width: 3px; }
    </style>
</head>
<body>

<div id="dashboard">
    <h1 style="color:var(--accent); font-size: 3.5rem; margin-bottom: 10px;">AnimatorShow</h1>
    <p style="margin-bottom: 30px; color: #888;">Crea animaciones y gu√°rdalas en tu PC</p>
    
    <div style="display: flex; gap: 15px;">
        <button onclick="startNewProject()" style="padding:15px 40px; border-radius:30px; border:none; background:var(--accent); color:white; font-weight:bold; cursor:pointer; font-size: 1.1rem;">+ NUEVO PROYECTO</button>
        <button onclick="document.getElementById('fileLoader').click()" style="padding:15px 30px; border-radius:30px; border:none; background:#6f42c1; color:white; font-weight:bold; cursor:pointer;">üìÇ CARGAR .JSON</button>
    </div>
    
    <input type="file" id="fileLoader" style="display:none" accept=".json" onchange="importProjectFile(event)">
    <div id="projectGrid" class="project-grid"></div>
</div>

<div id="editor">
    <header>
        <button onclick="location.reload()" style="background:#444; border:none; color:white; padding:8px 15px; border-radius:5px; cursor:pointer;">‚¨Ö Salir</button>
        <input type="text" id="projectName" value="Mi_Animacion" style="background:#333; color:white; border:none; padding:10px; border-radius:5px; width: 200px;">
        <div style="display:flex; gap:10px;">
            <button onclick="downloadJSON()" style="background:#555; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">üíæ Descargar .JSON</button>
            <button onclick="exportVideo()" class="btn-video">üé¨ EXPORTAR VIDEO (WebM)</button>
        </div>
    </header>

    <main>
        <div id="toolbar">
            <button class="btn-tool active" id="brushBtn" onclick="setTool('brush')">üñåÔ∏è</button>
            <button class="btn-tool" id="eraserBtn" onclick="setTool('eraser')">üßΩ</button>
            <button class="btn-tool" id="fillBtn" onclick="setTool('fill')">ü™£</button>
            <button class="btn-tool" id="lineBtn" onclick="setTool('line')">üìè</button>
            <button class="btn-tool" id="rectBtn" onclick="setTool('rect')">‚¨ú</button>
            <input type="color" id="colorPicker" value="#000000" style="width:50px; height:40px; border:none; cursor:pointer;">
            <input type="range" id="sizePicker" min="1" max="50" value="5" style="width:70px;">
            <hr width="80%">
            <button class="btn-tool" onclick="addFrame()">‚ûï</button>
            <button class="btn-tool" onclick="playPreview()">‚ñ∂Ô∏è</button>
        </div>

        <div id="viewport">
            <div id="canvas-wrapper">
                <canvas id="mainCanvas" width="800" height="450"></canvas>
                <canvas id="tempCanvas" width="800" height="450" style="pointer-events:none;"></canvas>
            </div>
        </div>
    </main>
    <div id="timeline"></div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const tCanvas = document.getElementById('tempCanvas');
    const tCtx = tCanvas.getContext('2d');
    
    let frames = [];
    let currentIdx = 0;
    let tool = 'brush';
    let isDrawing = false;
    let startX, startY;

    // --- DASHBOARD & PERSISTENCIA ---
    function startNewProject() {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('editor').style.display = 'flex';
        frames = [];
        addFrame();
    }

    function loadGallery() {
        const grid = document.getElementById('projectGrid');
        grid.innerHTML = '';
        Object.keys(localStorage).forEach(key => {
            if(key.startsWith('AS_PROJ_')) {
                const p = JSON.parse(localStorage.getItem(key));
                const card = document.createElement('div');
                card.className = 'project-card';
                card.innerHTML = `<h3>${p.name}</h3><small>${p.frames.length} cuadros</small>`;
                card.onclick = () => {
                    frames = p.frames;
                    document.getElementById('projectName').value = p.name;
                    document.getElementById('dashboard').style.display='none';
                    document.getElementById('editor').style.display='flex';
                    selectFrame(0);
                };
                grid.appendChild(card);
            }
        });
    }

    // --- HERRAMIENTAS ---
    function setTool(t) {
        tool = t;
        document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(t + 'Btn');
        if(btn) btn.classList.add('active');
    }

    canvas.onmousedown = (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        
        if(tool === 'fill') {
            floodFill(Math.floor(startX), Math.floor(startY), hexToRgb(document.getElementById('colorPicker').value));
            isDrawing = false;
            saveState();
        } else {
            ctx.beginPath();
            ctx.moveTo(startX, startY);
        }
    };

    canvas.onmousemove = (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const color = document.getElementById('colorPicker').value;
        const size = document.getElementById('sizePicker').value;

        tCtx.clearRect(0,0,800,450);

        if (tool === 'brush' || tool === 'eraser') {
            ctx.strokeStyle = (tool === 'eraser') ? '#FFFFFF' : color;
            ctx.lineWidth = (tool === 'eraser') ? 30 : size;
            ctx.lineCap = 'round';
            ctx.lineTo(x, y);
            ctx.stroke();
        } else if (tool === 'line') {
            tCtx.strokeStyle = color;
            tCtx.lineWidth = size;
            tCtx.beginPath(); tCtx.moveTo(startX, startY); tCtx.lineTo(x, y); tCtx.stroke();
        } else if (tool === 'rect') {
            tCtx.strokeStyle = color;
            tCtx.lineWidth = size;
            tCtx.strokeRect(startX, startY, x - startX, y - startY);
        }
    };

    canvas.onmouseup = () => {
        if (!isDrawing) return;
        if (tool === 'line' || tool === 'rect') ctx.drawImage(tCanvas, 0, 0);
        isDrawing = false;
        tCtx.clearRect(0,0,800,450);
        saveState();
    };

    // --- GESTI√ìN DE FRAMES ---
    function saveState() {
        frames[currentIdx] = canvas.toDataURL("image/png");
        updateTimeline();
        // Auto-guardado local en el navegador
        const name = document.getElementById('projectName').value;
        localStorage.setItem('AS_PROJ_' + name, JSON.stringify({name, frames}));
    }

    function addFrame() {
        if(frames.length > 0) saveState();
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, 800, 450);
        frames.push(canvas.toDataURL("image/png"));
        selectFrame(frames.length - 1);
    }

    function selectFrame(i) {
        currentIdx = i;
        const img = new Image();
        img.onload = () => {
            ctx.fillStyle = "white"; ctx.fillRect(0,0,800,450);
            ctx.drawImage(img, 0, 0);
            updateTimeline();
        };
        img.src = frames[i];
    }

    function updateTimeline() {
        const container = document.getElementById('timeline');
        container.innerHTML = '';
        frames.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = `frame-thumb ${i === currentIdx ? 'active' : ''}`;
            div.style.backgroundImage = `url(${f})`;
            div.onclick = () => selectFrame(i);
            container.appendChild(div);
        });
    }

    // --- IMPORTAR/EXPORTAR ---
    function downloadJSON() {
        const data = { name: document.getElementById('projectName').value, frames: frames };
        const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = data.name + ".json";
        a.click();
    }

    function importProjectFile(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = JSON.parse(e.target.result);
            frames = data.frames;
            document.getElementById('projectName').value = data.name;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('editor').style.display = 'flex';
            selectFrame(0);
        };
        reader.readAsText(file);
    }

    async function exportVideo() {
        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = document.getElementById('projectName').value + ".webm";
            a.click();
        };
        recorder.start();
        for (let i = 0; i < frames.length; i++) {
            await selectFrame(i);
            await new Promise(r => setTimeout(r, 200));
        }
        recorder.stop();
    }

    function playPreview() {
        let i = 0;
        const timer = setInterval(() => {
            selectFrame(i); i++;
            if(i >= frames.length) clearInterval(timer);
        }, 150);
    }

    function floodFill(startX, startY, fill) {
        const img = ctx.getImageData(0,0,800,450);
        const data = img.data;
        const i = (startY * 800 + startX) * 4;
        const target = [data[i], data[i+1], data[i+2]];
        if(target[0]===fill[0] && target[1]===fill[1] && target[2]===fill[2]) return;
        const stack = [[startX, startY]];
        while(stack.length) {
            const [x, y] = stack.pop();
            const idx = (y * 800 + x) * 4;
            if(x>=0 && x<800 && y>=0 && y<450 && data[idx]===target[0] && data[idx+1]===target[1] && data[idx+2]===target[2]) {
                data[idx]=fill[0]; data[idx+1]=fill[1]; data[idx+2]=fill[2]; data[idx+3]=255;
                stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
            }
        }
        ctx.putImageData(img, 0, 0);
    }
    function hexToRgb(h) { return [parseInt(h.slice(1,3),16), parseInt(h.slice(3,5),16), parseInt(h.slice(5,7),16)]; }

    window.onload = loadGallery;
</script>
</body>
</html>